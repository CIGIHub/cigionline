{% extends "base.html" %}
{% load webpack_loader %}

{% block title %}Manage registration — {{ event.title }}{% endblock %}

{% block extra_css %}
  {% render_bundle 'eventPage' 'css' %}
{% endblock %}

{% block extra_js %}
  {% render_bundle 'eventPage' 'js' %}
{% endblock %}

{% block content %}
{% include "includes/heroes/hero_event.html" with topics=event.topics_sorted title=event.title date=event.publishing_date end_date=event.event_end event_type=event.get_event_type_display event_access=event.get_event_access_display authors=event.authors.all author_count=event.author_count registration_url=event.registration_url time_zone=event.time_zone time_zone_label=event.time_zone_label is_past=event.is_past %}

<section class="event-registration-form-section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <a href="{{ event.url }}" class="btn btn-link p-2 mb-3">&larr; Back to event</a>

        {% if request.GET.gid %}
          <a
            href="{{ event.url }}register/manage/group/?gid={{ request.GET.gid }}&t={{ token }}"
            class="btn btn-link p-2 mb-3">
            &larr; Back to registrants
          </a>
        {% endif %}

        <p class="text-muted mb-4">Manage your registration</p>

        {% if request.GET.updated %}
          <div class="alert alert-success mb-4">Your registration has been updated.</div>
        {% endif %}
        {% if request.GET.cancelled %}
          <div class="alert alert-warning mb-4">Your registration has been cancelled.</div>
        {% endif %}

        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }} mb-4">{{ message }}</div>
          {% endfor %}
        {% endif %}

        <div class="cigi-alert mb-4">
          <ul>
            <li><strong>Name:</strong> {{ registrant.first_name }} {{ registrant.last_name }}</li>
            <li><strong>Email:</strong> {{ registrant.email }}</li>
            <li><strong>Status:</strong> {{ registrant.get_status_display }}</li>
          </ul>
        </div>

        {% if registrant.status == "cancelled" %}
          <div class="alert alert-warning" role="alert">This registration is already cancelled.</div>
        {% else %}
          <form method="post" action="{{ event.url }}register/manage/update/?rid={{ registrant.pk }}&t={{ token }}{% if request.GET.gid %}&gid={{ request.GET.gid }}{% endif %}" enctype="multipart/form-data">
            {% csrf_token %}

            {# Non-field errors (e.g., conditional validation) #}
            {% if form.non_field_errors %}
              <div class="cigi-alert">
                <ul>{% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}</ul>
              </div>
            {% endif %}

            {# Basic identity — two columns #}
            <div class="cigi-grid cigi-grid--2">
              {% include "events/includes/_field.html" with field=form.first_name %}
              {% include "events/includes/_field.html" with field=form.last_name %}
            </div>

            {# Do not allow changing email, but show it as read-only context #}
            <div class="cigi-field">
              <div class="cigi-label"><span>Email</span></div>
              <div class="text-muted">{{ registrant.email }}</div>
            </div>

            {# Render remaining dynamic fields (skip identity + email + honeypot) #}
            {% for field in form %}
              {% if field.name != 'first_name' and field.name != 'last_name' and field.name != 'email' and field.name != 'website' %}
                {% include "events/includes/_field.html" with field=field %}
              {% endif %}
            {% endfor %}

            {# Honeypot: render but hide visually #}
            {% if form.website %}
              <div class="visually-hidden" aria-hidden="true">
                {{ form.website.label_tag }}{{ form.website }}
              </div>
            {% endif %}

            <div class="cigi-actions">
              <button type="submit" class="btn btn-primary">Save changes</button>
              <a class="btn" href="{{ event.url }}">Back to event</a>
            </div>
          </form>

          <hr />

          <form method="post" action="{{ event.url }}register/manage/cancel/?rid={{ registrant.pk }}&t={{ token }}{% if request.GET.gid %}&gid={{ request.GET.gid }}{% endif %}">
            {% csrf_token %}
            <div class="cigi-actions">
              <button type="submit" class="btn" onclick="return confirm('Cancel your registration?');">Cancel registration</button>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% endblock %}
