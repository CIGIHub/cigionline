{% extends "wagtailadmin/base.html" %}
{% load i18n %}

{% block titletag %}Registrants · {{ rtype.name }} · {{ event.title }}{% endblock %}

{% block content %}
  <header class="nice-padding">
    <h1 class="w-header__title">
      Registrants – {{ rtype.name }} <small>({{ event.title }})</small>
    </h1>
    <p>
      <a href="{% url detail_url_name event.pk %}" class="button button-secondary">Back to event</a>
    </p>
  </header>

  <section class="nice-padding registration-registrants-report-section">
    <form method="get" class="filter-form">
      <input type="text" name="q" value="{{ q }}" placeholder="Search name or email">
      <select name="status">
        <option value="">All statuses</option>
        <option value="confirmed" {% if status == 'confirmed' %}selected{% endif %}>Confirmed</option>
        <option value="waitlisted" {% if status == 'waitlisted' %}selected{% endif %}>Waitlisted</option>
        <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pending</option>
      </select>
      <button class="button">Filter</button>
    </form>

    <div class="x-scroll">
      <table class="listing full-width nowrap">
        <thead>
          <tr>
            <th>ID</th>
            <th>Created</th>
            <th>Name</th>
            <th>Email</th>
            <th>Status</th>
            <th>Invited</th>
            <th>Edit</th>
  
            {% for col in columns %}
              <th>{{ col.label }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for r in page_obj %}
            <tr>
              <td>{{ r.pk }}</td>
              <td>{{ r.created_at|date:"Y-m-d H:i" }}</td>
              <td>
                <a href="{{ r.edit_url }}">
                  {{ r.first_name }} {{ r.last_name }}
                </a>
              </td>
              <td>{{ r.email }}</td>
              <td>{{ r.status }}</td>
              <td>{{ r.invited }}</td>
  
              <td class="actions" style="white-space:nowrap;">
                <div style="display:flex; flex-wrap:nowrap; gap:0.35rem; align-items:center;">
                  <a class="button button-small" href="{{ r.edit_url }}">Edit</a>
                  <a class="button button-small button-secondary" href="{{ r.edit_answers_url }}">Edit answers</a>
                  <form method="post" action="{% url unregister_url_name pk=event.pk registrant_id=r.pk %}" style="margin:0;">
                    {% csrf_token %}
                    <button class="button button-small button-secondary"
                            style="background:#fff0f0; border-color:#e8b4b4; color:#a00;"
                            onclick="return confirm('Unregister {{ r.email }}?');">
                      Unregister
                    </button>
                  </form>
                </div>
              </td>
  
              {% for cell in r.answer_cells %}
                <td>
                  {% if cell.url %}
                    <a href="{{ cell.url }}" target="_blank" rel="noopener noreferrer">{{ cell.text }}</a>
                  {% else %}
                    {{ cell.text }}
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if page_obj.paginator.num_pages > 1 %}
      <nav class="pagination">
        {% if page_obj.has_previous %}
          <a class="button" href="?p={{ page_obj.previous_page_number }}&q={{ q }}&status={{ status }}">Previous</a>
        {% endif %}
        <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a class="button" href="?p={{ page_obj.next_page_number }}&q={{ q }}&status={{ status }}">Next</a>
        {% endif %}
      </nav>
    {% endif %}
  </section>
{% endblock %}
